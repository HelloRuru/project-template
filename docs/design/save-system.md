# 存檔系統設計

> 最後更新：2026-02-23

---

## 設計原則

1. **永遠不丟失進度**：手機當機、網頁跳掉都不會丟存檔
2. **跨裝置無縫銜接**：換手機只要登入就能繼續玩
3. **關鍵時刻自動存檔**：玩家不需要手動存檔也安全

---

## 存檔架構

```
┌─────────────┐     ┌──────────────┐
│  localStorage │────▶│  Supabase DB  │
│  （即時快取）  │◀────│ （雲端存檔）   │
└─────────────┘     └──────────────┘
       │                    │
       ▼                    ▼
  離線也能玩         換裝置也能玩
```

### 三層存檔

| 層級 | 儲存位置 | 用途 |
|------|---------|------|
| L1 即時 | 記憶體（Zustand store） | 遊戲運行中的即時狀態 |
| L2 快取 | localStorage | 離線保護、防當機 |
| L3 雲端 | Supabase PostgreSQL | 跨裝置同步、永久儲存 |

---

## 自動存檔觸發時機

### 強制存檔（一定存）

- 進入新章節 / 關卡前
- 做出重大劇情選擇前（結盟、背叛、下毒）
- 決定是否與某人結緣
- 懷孕確認
- 生產事件
- 位份晉升 / 降位
- 世代傳承切換前
- 玩家登出時

### 定時存檔

- 每 60 秒自動存檔到 localStorage
- 每 5 分鐘同步到 Supabase 雲端

### 操作存檔（debounce 2 秒）

- 完成一次日常行動後
- 完成一段對話後
- 獲得 / 使用道具後

---

## 存檔欄位

### 多存檔位

- 1 個**自動存檔**（系統管理，玩家不可覆蓋）
- 5 個**手動存檔**（玩家自行管理）
- 每個存檔包含：時間戳、角色名、位份、章節、截圖預覽

### 存檔資料結構（草案）

```json
{
  "save_id": "uuid",
  "user_id": "uuid",
  "slot": 0,
  "created_at": "timestamp",
  "updated_at": "timestamp",
  "game_state": {
    "generation": 1,
    "chapter": "ch01_selection",
    "character": {
      "name": "玩家名",
      "rank": "答應",
      "attributes": {
        "beauty": 70,
        "talent": 55,
        "cunning": 60,
        "health": 80,
        "charisma": 65,
        "luck": 50
      }
    },
    "relationships": {},
    "inventory": [],
    "family_tree": {},
    "story_flags": {},
    "events_seen": []
  }
}
```

---

## 跨裝置同步流程

### 登入時

```
1. 讀取雲端最新存檔
2. 讀取本地 localStorage 存檔
3. 比較兩者的 updated_at 時間戳
4. 若一致 → 直接載入
5. 若雲端較新 → 載入雲端版本
6. 若本地較新 → 提示玩家選擇：
   「偵測到本機有較新的存檔，要使用本機存檔還是雲端存檔？」
```

### 遊玩中斷線

```
1. 偵測到網路斷線
2. 顯示「離線模式」提示
3. 繼續遊戲，所有存檔寫入 localStorage
4. 恢復網路後自動同步到雲端
```

---

## 防作弊考量

- 存檔資料在伺服器端做基本驗證
- 關鍵數值（位份、屬性上限）由伺服器校驗
- 避免玩家透過修改 localStorage 作弊
- 但單機體驗為主，不需過度嚴格
